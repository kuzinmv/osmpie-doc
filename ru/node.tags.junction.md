# Пересечения и перекрестки

Описание пересечений в OSM, как и многое, достаточно хаотично и лоскутно.
[См. Key:junction](https://wiki.openstreetmap.org/wiki/Key:junction) Чтобы готовить перекрестки
более совершенными, надо систематизировать существующие теги и... добавить еще немного хаоса)))

```osm
node
    junction = controlled|uncontrolled|inout|joint 
```

Продолжая развивать тему тегирования точек, в настоящее время существуют и применяются теги [`junction=yes`](https://wiki.openstreetmap.org/wiki/Tag:junction%3Dyes),
[`junction=uncontrolled`](https://wiki.openstreetmap.org/wiki/Tag:junction%3Duncontrolled)
При работе над рендером мы провели классификацию пересечений, которые вероятно стоит различать, и предлагаем расширить этот список, но сначала...

**Основные признаки пересечений**

- `Участники` - точка принадлежит 2 и более way
- `Размер` - неотъемлемым, хотя и не всегда явным атрибутом пересечения будет являться некая фигура, площадь, многоугольник - нечто, что будет соотноситься (описывать, вписывать) 
с реальными линейными размерами места, где будет (не обязательно) происходить конфликт участников движения.
В osmpie мы предложили использовать окружность и соответственно радиус как атрибут, см. `cluster:radius`  
- `Связность` - появляются такие понятия (точки) входа и выхода в пересечение и необходимости указания (атрибуции) их связи друг с другом. См. connect:lanes, relation[type=connectivity]
- `Конфликтные точки` - необязательный, часто присутствующий признак - конфликтности одних связей с другими и место (координаты) этого конфликта.

Существует еще один признак пересечений, но он уже относится не к пересечению самому по себе, а к их множествам.
Пересечения склонны группироваться в сложные объекты - "перекрестки" - то есть образовывать явные и конечные множества.
Самым оптимальным вариантом атрибутирования, который бы мог управлять процессом и соответственно результатом кластеризации,
тоже является радиус окружности - см. тег junction:cluster:radius.

**Классификация пересечений:**  
* `junction = controlled` - контролируемое пересечение со светофором
* `junction = uncontrolled` - неконтролируемое пересечение/перекресток, как это используется сейчас
* `junction = inout` - в пересечении участвует `way[highway=service]` - въезд/выезд со дворов
* `junction = joint` - в пересечении участвует ровно 2 `way`, общая точка - это конец одного и начало другого

Все эти значения вычислимы по другим ключам и тегам участвующих в соединении объектов, 
то есть, по большому счету, не требуют явной установки. Однако редко, но бывают моменты,
когда стоит задать явно, например, когда в регулируемом пересечении участвуют выходы из парковок и дворов
`way[highway=service]`.

* `junction = controlled` - node принадлежит 2 и более way, и у нее есть теги светофоров
`(highway == traffic_signals || crossing == traffic_signals) == true`
* `junction = uncontrolled` - node принадлежит 2 и более way и нет тегов о светофорах
`(highway == traffic_signals || crossing == traffic_signals) == false`   
* `junction = inout` - node принадлежит 2 и более way, и хотя бы один из них `way[highway=service]`
* `junction = joint` - в пересечении участвует ровно 2 way, помеченные как дорога (не `footway,tram,cycleway`)

**Зачем нужна такая классификация junction для node**

- Как и любые явные теги, для более удобной выборки, фильтрации и поиска. 
Гораздо проще фильтровать объекты по атрибуту, чем рекурсивно выискивать связи и списки тегов.
- Для помеченной как `junction` явно (по желанию пользователя) точки рендер начинает правильно интерпретировать
и другие `junction:*=` теги, например `junction:radius` или `junction:cluster:radius`
- тип `junction=inout` нужен, чтобы явно отметить точки пересечения с `highway[service]`,
так как эти точки часто могут быть без тегов, или service ways могут фильтроваться при рендере,
а наличие информации о пересечении с сервисной дорогой важно для разметки парковок и других вещей, которые 
остаются на основной дороге, даже если сервисной дороги нет в рассмотрении.
- тип `junction=joint` может показаться очень необычным или непонятным пересечением - почему два стыкующихся
пути нужно классифицировать как пересечение. Если не происходит изменения количества полос - то в этом нет
необходимости, но если в 2 ways разное число полос, то в этом узле, так же как и в других
случаях, появляются маневры - перестроения, которые имеют протяженность (cluster:radius) и связность (connect:lanes)
и поэтому это тоже пересечение, хоть и специфический частный случай.

Добавить картинок примеров.

**Дополнительные обработки**

Для каждой ноды, где есть тег junction, заданный явно или вычисленный движком osmpie, производится также 
estimate значения `junction:radius` на основе количества участников пересечения и их полосности, что 
не отменяет того, что значение может быть задано явно пользователем.

Формула сейчас выведена приблизительно и "на глаз", дает в среднем неплохой результат, снижающий ручную работу, но в сложных случаях,
конечно, все придется брать в свои руки.