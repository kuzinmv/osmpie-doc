# Как приготовить идеальный перекресток в OpenStreetMap?
>ключевые теги и рекомендации


Для создания идеального перекрестка в OSMPIE нам потребуются следующие ингридиенты:

[Количество полос](#1-количество-полос) *
[Повороты и связность](#2-повороты-и-связность) *
[Ширина и положение полос](#3-ширина-полос-и-положение-от-осевой-линии) *
[Типы пересечений и новые тэги junction:*](#4-пересечения-и-перекрестки) *
[Парковки, остановки, велодорожки](#5-парковки-остановки-велодорожки-и-трамваи) *
[Вспомогательные теги](#6-вспомогательные-теги-для-управления-рендером) *
[Дорожная разметка (в разработке)](#7-разметка-скоро)


## 1. Количество полос

Для корректного отображения дорог необходимо правильно указать количество полос и их направление. Основные теги:


```osm
way
    oneway = yes|no
    lanes = 5
    lanes:forward = 3
    lanes:backward = 2
    lanes:both_ways = 1
```

**Важно:**  
- Если теги не указаны, рендер по умолчанию использует 2 полосы и двустороннее движение.  
- Дополнительные теги для специальных полос (например, для общественного транспорта):  
  - [`lanes:psv`](https://wiki.openstreetmap.org/wiki/Key:lanes:psv)  
  - [`psv:lanes`](https://wiki.openstreetmap.org/wiki/Key:psv:lanes)  

---

## 2. Повороты и связность

Ключевые теги для управления поворотами и соединениями полос:
Определенно ключ [turn](https://wiki.openstreetmap.org/wiki/Key:turn) является одним из ключевых ингредиентов 
хорошо приготовленного перекрестка или развязки и он используется на полную, поэтому обязательно необходимо 
ознакомиться со статьей .

```osm
way
    turn:lanes
    connect:lanes
relation 
    type = restriction
    type = connectivity
```

**Особенности:**  
По умолчанию если повороты не заданы используется веерная схема `left;through|...|through;right` в зависимости от количества полос.

Так же существует два отношения, которые определюят возможность/невозможность маневров. 
- Отношение типа `restriction` поддерживается рендером, правда пока без уточняющих суффиксов типа restriction:hov.

- Отношение `connectivity` в настоящее время пока не реализовано. 
В качестве альтернативы для более удобного задания сложных соединений на перекрестке 
мы предлагаем вместо отношения использовать ключ `coonnect:lanes` об этом есть дополнительная статья. 
[connect:lanes](./way.tags.connect:lanes.md).  
 



---

## 3. Ширина полос и положение от осевой линии

Большинство тэгов указанных в статье про ширину различных объектов дороги применются для рендера osmpie
[Ширина улицы](https://wiki.openstreetmap.org/wiki/Key:width#Width_of_streets)
Кроме непосредственно тэга `width`, который задает полную ширину улицы.

```osm
way
    width:lanes
    placement
    placement:forward
    placement:backward
    placement = dist:[number]
    placement = transition
```

**Рекомендации:**  

Тэг `placement` является дефакто используемым в OSM и он полностью применяется для рендера.
И очень полезен для маппинга полос, так как действительно позволяет исправить ту ложь, которая
вносится осевыми линиями, для дорог с переменным числом полос или на развилках.

**Советуем** внимательно ознакомится с положениями и применениями этого очень важного тэга, 
особенно со значением `placement=transition`.  [Placement](https://wiki.openstreetmap.org/wiki/Proposal:Placement)


Однако, для точного мапинга, значения этого тега имеют некоторый недостаток, они адресуются к
краям или центру какой либо полосы, что сильно ограничивает его применение.

В osmpie мы предлагаем два небольших расширения для этого способа задания смещения осевой линии.

- . введение значеиния `dist:[number]`, например
```
placement = dist:2.5  // ось смещена вправо на 2.5 метра по направлению движения для односторониих путей
placement = dist:-2.5 // то же самое но влево.
```

- . предложение ввести суфиксы forward и backward и учет их отдельно друг от друга - раздвоение осевой
```
placement:forward = dist:-5
placement:backward = dist:-5
```

Это позволит смещать полосы движения накрест, меняя направления движения левосторонее на правосторонее, 
для коротких вэй для левых поворотов на перекрестках, когда автомобили расходятся правыми бортами. 

Делать небольшие пространственные разделения проезжих частей вокруг небольших 
препятствий, находящихся посередине проезжей части и многое другое. 
Все также продолжая мапить это одним объектом way 

[Примеры использования placement=* в OSMPIE](./examples/placement.md)

---

## 4. Пересечения и перекрестки

Описание пересечений в OSM как и многое достаточно хаотично и лоскутно.
[См Key:junction](https://wiki.openstreetmap.org/wiki/Key:junction) Чтобы готовить перекрестки
более совершенными надо систематизировать существующие тэги и .... добавить еще немного хаоса)))

```osm
node
    junction = controlled|uncontrolled|inout|joint 
    junction:shape = rectangle|oblique|staggered
    junction:radius = 9
    junction:cluster:radius = 15
    crossing:corner = yes|no
    
way 
    junction:radius:lanes:{direction}:{start|end} = ||1|9
    connect:lanes = 0|1;2|3||
```

Продолжая развивать тему тэгирования точек, сейчас существуют тэги `junction=yes`, `junction=uncontrolled`
При работе над рендером мы провели классификацию пересечений, которые стоит различать и расширили этот список.

**Классификация пересечений:**  
* `junction = controlled` - контролируемое пересечение со светофором
* `junction = uncontrolled` - не контролируемое пересечение/перекресток так как это используется сейчас
* `junction = inout` - в пересечении учавствует `way[highway=service]` - въезд/выезд со дворов
* `junction = joint` - в пересечении учавствует ровно 2 `way`, общая точка это конец одного и начало другого

Все эти значения вычислямые по другим ключам и тэгам учавствующих в соединений объектах, 
то есть, по большому счету не требуют явной уставноки, однако редко, но бывают моменты,
когда стоит задать явно, например когда в регулируемом пересечении учавствуют выходы из парковок и дворов
`way[highway=service]`.

* `junction = controlled` -  node принадлежит 2 и более way, и у нее есть тэги светофоров
`(highway == traffic_signals || crossing == traffic_signals) == true`
* `junction = uncontrolled` - node принадлежит 2 и более way и нет тэгов о светофорах
`(highway == traffic_signals || crossing == traffic_signals) == false`   
* `junction = inout` node принадлежит 2 и более way и хотя бы один из них `way[highway=service]`
* `junction = joint` - в пересечении учавствует ровно 2 way, помеченные как дорога (не `footway,tram,cycleway`)


**Новые теги для точного и полного картирования перекрестков:**  


Для каждой точки которая явно(маппером) или не явно(рендером) отмечена как junction
можно применять четыре новых ключа, которые мы предлагаем для более точного рендера пересечений и перекрестков. 
+2 новых ключа картировния для других признаков (не junction) 

1. `junction:shape` - форма пересечения (прямоугольник, парралелограм или супеньки) если явно не задана, то osmpie 
пытается автоматически определить исходя из угла пересечения way в этой точке, если их 2 или 4. Случаи для более 5 way
надо тэгировать явно и вручную.
2. `junction:radius` - радиус окружности соотносящийся с зоной конфликта, в котором учавствуют 
транспортные средства
3. `junction:radius:lanes` - переопреление зоны конфликта заданной в точке для выбранного объекта типа  way. 
Например смещения стоп линии, для каждой полосы объекта типа way. 
4. `junction:cluster:radius` - радиус окружности который нужен для объединения точек пересечений между собой 
в один "настоящий" в обычном понимании перекресток или в нашей терминологии - кластер пересечений. 
5. `crossing:corner = yes|no` - Тэг для точек пешеходных переходов, на подобие тэга `crossing:island`
[см crossing:island](https://wiki.openstreetmap.org/wiki/Key:crossing:island), который 
указывает на наличие островка безопасности. Этот тэг отмечает факт, что пешеходный переход находится 
очень близко к проезжей части с права или слева. То есть фактически проведен от одного угла тротуара 
к другому углу. Учет этого случая позволяет строить более правильные формы пересечения.
6. `connect:lanes` - более удобный способ адресации к полосам для точного указания связности в ноде, 
как альтернатива отношений. [relation[type=connectivity]](https://wiki.openstreetmap.org/wiki/Relation:connectivity)
 


Познакомьтесь со статьями, которые более подробно описывают эти ключи и их применение
- [junction:shape](./node.tags.junction:shape.md)
- [junction:radius](./node.tags.junction:radius.md)
- [junction:cluster:radius](./node.tags.junction:cluster:radius.md)
- [connect:lanes](./way.tags.connect:lanes.md)


---

## 5. Парковки, остановки, велодорожки и трамваи
В первой версии osmpie была добавлена частичная поддержка тэгов парковки и велодорожек.
Ровно в той мере в какой они влияют на ширину проезжей части и полгионы дороги.
Учитывается расположение и ширина, для парковок еще ориентация, которая определяет 
ширину парковочной полосы.

**Парковки и велодорожки:**  
```osm
way
    parking:{side} = lane|street_side
    parking:{side}:orientation = number
    parking:{side}:width = number
    
way   
    cycleway:{side} = lane
    cycleway:{side}:width = number    
```
[Ссылка на статьи примеры на эту тему](./examples/parking.md)

**Остановки:**
Отдельное внимание уделено автобусным остановкам. Предложено использовать ключ `bus_bay` не для
way, но и для node остановки `highway = bus_stop`, которая позволит указать что остановка находится 
в кармане и правильно отрисовать этот карман и разметку в нем. 
Для остановок в которых указан тэг `tram=yes` применяется другой вид разметки - перпендикулярный полосам движения
  
```osm
node
   highway = bus_stop + bus_bay = yes
   highway = bus_stop + tram = yes 
```

[Примеры использования bus_bay=yes в OSMPIE](./examples/bus_bay.md)

**Особенности:**  
-  Отдельно стоит упомянуть что пересечения автомобильных путей с трамвайными путями и велодорожками игнорируются, если не помечены какими либо тэгами,
например `highway = traffic_signals` потому что не требует решения связности этих пересечений, учет этих пересечений порождает много мелких ребер и 
искажет геометрическую картину полос на автомобильной дороге.  

---

## 6. Вспомогательные теги для управления рендером

В osmpie существует набор дополнительных тэгов, которыми можно управлять рендером. 
Большинство из них применяются крайне редко, в особо исключительных случаях:

```osm
    osmpie:{key} = any
    osmpie:sparse = yes|no|number
    osmpie:fill = yes|no|number
    osmpie:usefull = yes|no
```

* `osmpie:{key} = any` - переопределяет значения любого тэга если он есть. Например [перекресток на мосту или мост внутри перекрестка](https://www.openstreetmap.org/way/243947044#map=19/59.935411/30.326399). 
osmpie разделеят рендер полигонов дороги для разных уровней для тоннелей, развязок и перекрестков под/над ними, редко редко, но перекресток может быть частью моста
 или мост внутри перекрестка и тогда невозможно построить полигон перекрестка. И при этом изменить тэг level  для моста противоречит правилам OSM.
Тогда можно переопределить `osmpie:level = 0 + level = 2` 

* `osmpie:sparse = yes|no|number`  - В osmpie работает процедура удаления лишних точек на way, которые находятся блзко друг к другу и не имеют тэгов.
Этот тэг явным орбазом указывает надо ли это делать для конкретного вэй и с какими ограничениями

* `osmpie:fill = yes|no|number` - В osmpie работает процедура наполнения way точками, если есть длинные участки без точек 
Этот тэг явным орбазом указывает надо ли это делать для конкретного вэй и с какими ограничениями.

* `osmpie:usefull = yes|no` - Вэи типа `way[highway = service]` не используются для конечного рендера и фильтруются. Но иногда некоторые вэи полезны, 
этот тэг обозначает что его не надо удлаять

[Более подробные примеры на эту тему](./examples/fill.sparse.md)

---

## 7. Разметка (скоро)

В первой публичной версии osmpie разметка не управляема и генерируется по максимуму и может не отражать некоторых местных особенностей нанасения.
Например парковочных мест или пешеходных переходов. И ее рендер осуществляется, чтобы дать понять о существовании 
того или иного объекта, полосы и ее размерах. Однако мы надеемся это быстро исправить в первую очередь.

Типичными тегами, указывающими на дорожную разметку, являются, например, `divider`, `turn:lanes=*`, `overtaking=*`, `change=*` или `crossing:markings=*.` 
Наличие разметки на дороге можно указать с помощью `lane_markings=*` 
Использование вышеупомянутых тегов в сочетании 
с дополнительной информацией, такой как `placement=*` или `width:lanes=*`,
достаточно управления рендером дорожной разметки.

- [Key:divider](https://wiki.openstreetmap.org/wiki/Key:divider)
- [Key:change](https://wiki.openstreetmap.org/wiki/Key:change)
- [Key:overtaking](https://wiki.openstreetmap.org/wiki/Key:overtaking)
- [Key:crossing:markings](https://wiki.openstreetmap.org/wiki/Key:crossing:markings)
- [Key:lane_markings](https://wiki.openstreetmap.org/wiki/Key:lane_markings)
- [Tag:road_marking=solid_stop_line](https://wiki.openstreetmap.org/wiki/Tag:road_marking=solid_stop_line)

Отдельно стоит присмотреться к предложению [Proposal:Road_marking_revision](https://wiki.openstreetmap.org/wiki/Proposal:Road_marking_revision)
, которое мы поддерживаем на 99%, за исключением того что знаки поворотов и текстов на полосе должны быть обозначены как way объекты.
Возможно разрешить применять и к точечным объектам а угол задавать в атрибутах или вычислять из
угла way, которому принадлежит нода, с добавлением `direction = {forward|backward}`, как это применяется сейчас для [светофоров](https://wiki.openstreetmap.org/wiki/Key:traffic_signals:direction).
 