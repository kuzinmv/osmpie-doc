# Как приготовить идеальный перекресток в OpenStreetMap?
>ключевые теги и рекомендации


Для создания идеального перекрестка в OSMPIE нам потребуются следующие ингридиенты:

[Количество полос](#1-количество-полос)

[Повороты и связность](#2-повороты-и-связность)

[Ширина и положение полос](#3-ширина-полос-и-положение-от-осевой-линии)

[Типы пересечений и новые тэги junction:*](#4-пересечения-и-перекрестки)

[Парковки, остановки, велодорожки](#5-парковки-остановки-велодорожки-и-трамваи)

[Вспомогательные теги](#6-вспомогательные-теги-для-управления-рендером)

[Дорожная разметка (в разработке)](#7-разметка-скоро)


## 1. Количество полос

Для корректного отображения дорог необходимо правильно указать количество полос и их направление. Основные тэги:


```osm
way
    oneway:yes|no
    lanes:5
    lanes:forward:3
    lanes:backward:2
    lanes:both_ways:1
```

**Важно:**  
- Если тэги не указаны, рендер по умолчанию использует две полосы и двустороннее движение.  
- Дополнительные тэги для специальных полос (например, для общественного транспорта):  
  - [`lanes:psv`](https://wiki.openstreetmap.org/wiki/Key:lanes:psv)  
  - [`psv:lanes`](https://wiki.openstreetmap.org/wiki/Key:psv:lanes)  

---

## 2. Повороты и связность

Рассмотрим основные тэги для управления поворотами и соединениями полос.

Ключ [turn](https://wiki.openstreetmap.org/wiki/Key:turn) является одним из наиболее используемых ингредиентов 
хорошо приготовленного перекрестка (или развязки), поэтому настоятельно рекомендуем ознакомиться со статьей.

```osm
way
    turn:lanes
    connect:lanes
relation 
    type:restriction
    type:connectivity
```

**Особенности:**  
По умолчанию, если повороты не заданы, используется веерная схема `left;through|...|through;right` в зависимости от количества полос.

Также существуют два отношения, которые определюят возможность/невозможность маневров. 
- Отношение типа `restriction` поддерживается рендером, правда пока без уточняющих суффиксов типа restriction:hov.

- Отношение `connectivity` в настоящее время пока не реализовано. 
В качестве альтернативы, позволяющей с удобством задавать сложные соединения на перекрестке, 
мы предлагаем вместо отношения использовать ключ `coonnect:lanes`, о чем можно прочесть в дополнительной статье [connect:lanes](./way.tags.connect:lanes.md).  
 
---

## 3. Ширина полос и положение от осевой линии

Тэг `width` задает полную [ширину улицы](https://wiki.openstreetmap.org/wiki/Key:width#Width_of_streets).
Остальные тэги, описываемые в статье, применются в OSMPIE, чтобы задать ширину других объектов дороги.

```osm
way
    width:lanes
    placement
    placement:forward
    placement:backward
    placement:dist:[number]
    placement:transition
```

**Рекомендации:**  

Используемый в OSM тэг `placement` явяется чуть ли не единственным средством, которое позволяет исправить ошибки, 
создаваемые осевыми линиями на дорогах с изменяющимся количеством полос и на развилках. Данный тэг незаменим при маппинге полос.

**Советуем** внимательно ознакомится с положениями и применениями крайне важного тэга [placement](https://wiki.openstreetmap.org/wiki/Proposal:Placement), 
особенно со значением `placement:transition`.  

Обращаем внимание, что этот тэг адресуется к краям или центру какой-либо полосы, что сильно ограничивает его применение для точного мапинга.

В OSMPIE мы предлагаем два небольших расширения, чтобы задать смещение осевой линии.

- . `dist:[number]`, например
```
placement:dist:2.5  // ось смещена вправо на 2.5 метра по направлению движения для односторониих путей
placement:dist:-2.5 // то же самое, но влево.
```

- . вводя суфиксы forward и backward и учитывая их отдельно друг от друга, мы получаем раздвоение осевой
```
placement:forward:dist:-5
placement:backward:dist:-5
```

Это позволяет смещать полосы движения накрест, менять направления движения с левостороннего на правостороннее, что важно 
для коротких way, чтобы отразить левые повороты на перекрестках, где автомобили расходятся правыми бортами. 
Также можно отражать островки безопасности и разделения проезжих частей вокруг небольших 
препятствий, находящихся посередине проезжей части. И многое другое. При этом мы сохраняем топологию, продолжая маппинг единого объекта way. 

[Примеры использования placement=* в OSMPIE](./examples/placement.md)

---

## 4. Пересечения и перекрестки

Описание пересечений в OSM в настоящее время хаотично и лоскутно. Этот подход описан в статье
[key:junction](https://wiki.openstreetmap.org/wiki/Key:junction). Чтобы готовить перекрестки
более совершенными надо систематизировать существующие тэги и ... добавить еще немного хаоса!

```osm
node
    junction:controlled|uncontrolled|inout|joint 
    junction:shape:rectangle|oblique|staggered
    junction:radius:9
    junction:cluster:radius:15
    crossing:corner:yes|no
    
way 
    junction:radius:lanes:{direction}:{start|end}:||1|9
    connect:lanes:0|1;2|3||
```

Сейчас в OSM используются тэги `junction:yes`, `junction:uncontrolled`.
Мы расширили этот список с целью классификации различных пересечений.

**Классификация пересечений:**  
* `junction:controlled` - контролируемое пересечение со светофором
* `junction:uncontrolled` - не контролируемое пересечение/перекресток так как это используется сейчас
* `junction:inout` - в пересечении учавствует `way[highway=service]` - въезд/выезд со дворов
* `junction:joint` - в пересечении учавствует ровно 2 `way`, общая точка это конец одного и начало другого

В большинстве случаев рендер автоматически вычисляет эти тэги по другим ключам и тэгам, учавствующим в соединений объектах.
В таких случаях эти тэги не требуются прописывать или изменять. В редких случаях, например, когда в регулируемом пересечении учавствуют выходы из парковок и дворов
`way[highway:service]`, перечисленные тэги следует задать явно, 

* `junction:controlled` -  node принадлежит 2 и более way, и у нее есть тэги светофоров
`(highway == traffic_signals || crossing == traffic_signals) == true`
* `junction:uncontrolled` - node принадлежит 2 и более way и нет тэгов о светофорах
`(highway == traffic_signals || crossing == traffic_signals) == false`   
* `junction:inout` node принадлежит 2 и более way и хотя бы один из них `way[highway=service]`
* `junction:joint` - в пересечении учавствует ровно 2 way, помеченные как дорога (не `footway,tram,cycleway`)


**Новые теги для точного и полного картирования перекрестков:**  


Для каждой точки, отмеченной как junction (вручную маппером или автоматически рендером),
можно применять четыре новых ключа, которые мы предлагаем для более точного рендера пересечений и перекрестков, 
а также два новых ключа для картирования иных признаков. 

1. `junction:shape` - определяет форму пересечения (прямоугольник, парралелограм или супеньки); если явно не задана, то osmpie 
пытается автоматически определить исходя из угла пересечения ways в этой точке, но рендер может вычислить форму, только если пересекаются 2 или 4 ways.
В случаях пересечения 5 ways и более необходимо задавать тэги явно и вручную.
3. `junction:radius` - радиус окружности, соотносящийся с зоной конфликта, в котором участвуют транспортные средства на данном перекрестке.
4. `junction:radius:lanes` - переопределение зоны конфликта, заданной в точке для выбранного объекта типа way. 
Например смещения стоп линии для каждой полосы объекта типа way. 
5. `junction:cluster:radius` - минимальный радиус окружности, объединяющий точки пересечений ways в один кластер пересечений, что соответствует "настоящему перекрестку" в обычном понимании.
6. `crossing:corner:yes|no` - тэг для точек пешеходных переходов. Оформляется наподобие тэга `crossing:island`, как описано в статье
   [crossing:island](https://wiki.openstreetmap.org/wiki/Key:crossing:island), который 
указывает на наличие островка безопасности. Тэг `crossing:corner` отмечает факт, что пешеходный переход находится 
очень близко к проезжей части справа или слева. То есть фактически проведен от угла одного тротуара 
до угла тротуара противоположной стороны way. Учет такого пешеходного перехода позволяет строить топологически правильные формы пересечения.
7. `connect:lanes` - удобный способ адресации к полосам для точного указания связности в ноде. Используется
как альтернатива отношений [relation[type=connectivity]](https://wiki.openstreetmap.org/wiki/Relation:connectivity)
 


Познакомьтесь со статьями, которые описывают эти ключи и их применение подробнее
- [junction:shape](./node.tags.junction:shape.md)
- [junction:radius](./node.tags.junction:radius.md)
- [junction:cluster:radius](./node.tags.junction:cluster:radius.md)
- [connect:lanes](./way.tags.connect:lanes.md)


---

## 5. Парковки, остановки, велодорожки и трамваи
В первой версии OSMPIE реализована частичная поддержка тэгов парковки и велодорожек.
Учитываются только те параметры, которые влияют на ширину проезжей части и полгионы дороги, то есть расположение и ширина.
Для парковки также учитывается ориентация, поскольку она определяет ширину парковочной полосы.

**Парковки и велодорожки:**  
```osm
way
    parking:{side} = lane|street_side
    parking:{side}:orientation = number
    parking:{side}:width = number
    
way   
    cycleway:{side} = lane
    cycleway:{side}:width = number    
```
[Примеры использования cycling и parking в OSMPIE](./examples/parking.md)

**Остановки:**
Отдельное внимание уделено автобусным остановкам. Предлагается использовать ключ `bus_bay` не только для
way, но и для node остановки `highway = bus_stop`, чтобы указать, что остановка находится 
в кармане. Таким образом возникает задача отрисовать этот карман и разметку в нем.

Для остановок в которых указан тэг `tram=yes` применяется иной вид разметки - перпендикулярный полосам движения
  
```osm
node
   highway = bus_stop + bus_bay = yes
   highway = bus_stop + tram = yes 
```

[Примеры использования bus_bay=yes в OSMPIE](./examples/bus_bay.md)

**Особенности:**  
Отдельно стоит упомянуть что пересечения автомобильных путей с трамвайными путями и велодорожками игнорируются, если они не помечены подходящими тэгами,
например `highway = traffic_signals`. Отсутствие тэгов означает, что здесь не требуется решение связности этих пересечений. Учет этих пересечений без определения
связанности и отношений порождает множество мелких ребер, что искажет геометрическую картину полос на автомобильной дороге.  

---

## 6. Вспомогательные теги для управления рендером

В OSMPIE существует набор дополнительных тэгов, с помощью которых можно управлять рендером. 
Большинство из них применяются крайне редко. Рассмотрим эти исключительные случаи:

```osm
    osmpie:{key} = any
    osmpie:sparse = yes|no|number
    osmpie:fill = yes|no|number
    osmpie:usefull = yes|no
```

* `osmpie:{key} = any` - переопределяет значения любого тэга если он есть. Например [перекресток на мосту или мост внутри перекрестка](https://www.openstreetmap.org/way/243947044#map=19/59.935411/30.326399). 
osmpie разделяет рендер полигонов разных уровней дороги для случаев тоннелей и развязок с перекрестками на других уровнях.
В редких случаях перекресток может быть частью моста, либо мост может находиться внутри перекрестка. А таких конструкциях OSM не позволяет построить полигон перекрестка,
а изменить тэг level для моста противоречит правилам OSM.

В OSMPIE можно переопределить `osmpie:level = 0 + level = 2` 

* `osmpie:sparse = yes|no|number`  - В osmpie работает процедура удаления лишних точек на way, которые находятся блзко друг к другу и не имеют тэгов.
Этот тэг явным орбазом указывает, надо ли проводить процедуру удаления для конкретного way и, если надо, то с какими ограничениями.

* `osmpie:fill = yes|no|number` - В osmpie работает процедура наполнения way точками, если way содержит длинные участки без точек. 
Этот тэг явным орбазом указывает, надо ли проводить процедуру наполнения для конкретного way и, если надо, то с какими ограничениями.

* `osmpie:usefull = yes|no` - Ways типа `way[highway = service]` не используются для конечного рендера и фильтруются. Но иногда некоторые way такого типа полезны. 
Этот тэг обозначает, что конкретный way не надо удалять.

[Примеры использования этих тэгов в OSMPIE](./examples/fill.sparse.md)

---

## 7. Разметка

В первой публичной версии osmpie разметка не управляема и генерируется автоматически. Поэтому она может не отражать некоторых местных особенностей нанасения,
как то парковочные места или пешеходные переходы. Рендер разметки осуществляется только с целью указать на существование разметки 
конкретных объектов (например, полосы) и ее размерах. Одна из первоочередных задач — открыть возможность редактирования разметки.

Типичными тэгами, указывающими на дорожную разметку, являются `divider`, `turn:lanes=*`, `overtaking=*`, `change=*` или `crossing:markings=*.` 
Наличие разметки на дороге можно указать с помощью тэга `lane_markings=*` 
Использование вышеупомянутых тэгов в сочетании с дополнительной информацией, такой как `placement=*` или `width:lanes=*`,
достаточно для управления рендером дорожной разметки.

- [Key:divider](https://wiki.openstreetmap.org/wiki/Key:divider)
- [Key:change](https://wiki.openstreetmap.org/wiki/Key:change)
- [Key:overtaking](https://wiki.openstreetmap.org/wiki/Key:overtaking)
- [Key:crossing:markings](https://wiki.openstreetmap.org/wiki/Key:crossing:markings)
- [Key:lane_markings](https://wiki.openstreetmap.org/wiki/Key:lane_markings)
- [Tag:road_marking=solid_stop_line](https://wiki.openstreetmap.org/wiki/Tag:road_marking=solid_stop_line)

Отдельно стоит присмотреться к предложению [Proposal:Road_marking_revision](https://wiki.openstreetmap.org/wiki/Proposal:Road_marking_revision).
Данный принцип редактирования разметки поддерживается OSMPIE за исключением того, что знаки поворотов и текст, изображенные на полосе, должны быть обозначены как way объекты.
Этот подход можно применять и к точечным объектам. В таком случае требуется задавать угол в атрибутах. Это можно сделать вручную или вычислять из
угла way, которому принадлежит нода, с добавлением `direction = {forward|backward}`, 
как это применяется сейчас для [светофоров](https://wiki.openstreetmap.org/wiki/Key:traffic_signals:direction).
 
