# Как приготовить идеальный перекрёсток в OpenStreetMap?
> ключевые теги и рекомендации

Для создания идеального перекрёстка в OSMPIE нам потребуются следующие ингредиенты:

[Количество полос](#1-количество-полос) *
[Повороты и связность](#2-повороты-и-связность) *
[Ширина и положение полос](#3-ширина-полос-и-положение-от-осевой-линии) *
[Типы пересечений и новые теги junction:*](#4-пересечения-и-перекрестки) *
[Парковки, остановки, велодорожки](#5-парковки-остановки-велодорожки-и-трамваи) *
[Вспомогательные теги](#6-вспомогательные-теги-для-управления-рендером) *
[Дорожная разметка (в разработке)](#7-разметка-скоро)

## 1. Количество полос

Для корректного отображения дорог необходимо правильно указать количество полос и их направление. Основные теги:

```osm
way
    oneway = yes|no
    lanes = 5
    lanes:forward = 3
    lanes:backward = 2
    lanes:both_ways = 1
```

**Важно:**  
- Если теги не указаны, рендер по умолчанию использует 2 полосы и двустороннее движение.  
- Дополнительные теги для специальных полос (например, для общественного транспорта):  
  - [`lanes:psv`](https://wiki.openstreetmap.org/wiki/Key:lanes:psv)  
  - [`psv:lanes`](https://wiki.openstreetmap.org/wiki/Key:psv:lanes)  

---

## 2. Повороты и связность

Ключевые теги для управления поворотами и соединениями полос:
Определённо ключ [turn](https://wiki.openstreetmap.org/wiki/Key:turn) является одним из ключевых ингредиентов 
хорошо приготовленного перекрёстка или развязки, и он используется на полную, поэтому обязательно необходимо 
ознакомиться со статьёй.

```osm
way
    turn:lanes
    connect:lanes
relation 
    type = restriction
    type = connectivity
```

**Особенности:**  
По умолчанию, если повороты не заданы, используется веерная схема `left;through|...|through;right` в зависимости от количества полос.

Также существуют два отношения, которые определяют возможность/невозможность манёвров. 
- Отношение типа `restriction` поддерживается рендером, правда пока без уточняющих суффиксов типа restriction:hov.

- Отношение `connectivity` в настоящее время пока не реализовано. 
В качестве альтернативы для более удобного задания сложных соединений на перекрёстке 
мы предлагаем вместо отношения использовать ключ `connect:lanes` — об этом есть дополнительная статья. 
[connect:lanes](./way.tags.connect:lanes.md).  

---

## 3. Ширина полос и положение от осевой линии

Большинство тегов, указанных в статье про ширину различных объектов дороги, применяются для рендера osmpie
[Ширина улицы](https://wiki.openstreetmap.org/wiki/Key:width#Width_of_streets)
Кроме непосредственно тега `width`, который задаёт полную ширину улицы.

```osm
way
    width:lanes
    placement
    placement:forward
    placement:backward
    placement = dist:[number]
    placement = transition
```

**Рекомендации:**  

Тег `placement` является де-факто используемым в OSM, и он полностью применяется для рендера.
И очень полезен для маппинга полос, так как действительно позволяет исправить ту ложь, которая
вносится осевыми линиями для дорог с переменным числом полос или на развилках.

**Советуем** внимательно ознакомиться с положениями и применениями этого очень важного тега, 
особенно со значением `placement=transition`.  [Placement](https://wiki.openstreetmap.org/wiki/Proposal:Placement)

Однако для точного маппинга значения этого тега имеют некоторый недостаток: они адресуются к
краям или центру какой-либо полосы, что сильно ограничивает его применение.

В osmpie мы предлагаем два небольших расширения для этого способа задания смещения осевой линии.

- Введение значения `dist:[number]`, например:
```
placement = dist:2.5  // ось смещена вправо на 2.5 метра по направлению движения для односторонних путей
placement = dist:-2.5 // то же самое, но влево.
```

- Предложение ввести суффиксы forward и backward и учёт их отдельно друг от друга — раздвоение осевой:
```
placement:forward = dist:-5
placement:backward = dist:-5
```

Это позволит смещать полосы движения накрест, меняя направления движения левостороннее на правостороннее, 
для коротких вэй для левых поворотов на перекрёстках, когда автомобили расходятся правыми бортами. 

Делать небольшие пространственные разделения проезжих частей вокруг небольших 
препятствий, находящихся посередине проезжей части, и многое другое. 
Всё также продолжая мапить это одним объектом way. 

[Примеры использования placement=* в OSMPIE](./examples/placement.md)

---

## 4. Пересечения и перекрёстки

Описание пересечений в OSM, как и многое, достаточно хаотично и лоскутно.
[См. Key:junction](https://wiki.openstreetmap.org/wiki/Key:junction) Чтобы готовить перекрёстки
более совершенными, надо систематизировать существующие теги и... добавить ещё немного хаоса)))

```osm
node
    junction = controlled|uncontrolled|inout|joint 
    junction:shape = rectangle|oblique|staggered
    junction:radius = 9
    junction:cluster:radius = 15
    crossing:corner = yes|no
    
way 
    junction:radius:lanes:{direction}:{start|end} = ||1|9
    connect:lanes = 0|1;2|3||
```

Продолжая развивать тему тегирования точек, сейчас существуют теги `junction=yes`, `junction=uncontrolled`.
При работе над рендером мы провели классификацию пересечений, которые стоит различать, и расширили этот список.

**Классификация пересечений:**  
* `junction = controlled` - контролируемое пересечение со светофором
* `junction = uncontrolled` - неконтролируемое пересечение/перекрёсток, как это используется сейчас
* `junction = inout` - в пересечении участвует `way[highway=service]` — въезд/выезд со дворов
* `junction = joint` - в пересечении участвует ровно 2 `way`, общая точка — это конец одного и начало другого

Все эти значения вычислимы по другим ключам и тегам участвующих в соединении объектов, 
то есть, по большому счёту, не требуют явной установки. Однако редко, но бывают моменты,
когда стоит задать явно, например, когда в регулируемом пересечении участвуют выходы из парковок и дворов
`way[highway=service]`.

* `junction = controlled` - node принадлежит 2 и более way, и у неё есть теги светофоров
`(highway == traffic_signals || crossing == traffic_signals) == true`
* `junction = uncontrolled` - node принадлежит 2 и более way и нет тегов о светофорах
`(highway == traffic_signals || crossing == traffic_signals) == false`   
* `junction = inout` - node принадлежит 2 и более way, и хотя бы один из них `way[highway=service]`
* `junction = joint` - в пересечении участвует ровно 2 way, помеченные как дорога (не `footway,tram,cycleway`)

**Новые теги для точного и полного картирования перекрёстков:**  

Для каждой точки, которая явно (маппером) или неявно (рендером) отмечена как junction,
можно применять четыре новых ключа, которые мы предлагаем для более точного рендера пересечений и перекрёстков. 
+2 новых ключа картирования для других признаков (не junction). 

1. `junction:shape` - форма пересечения (прямоугольник, параллелограмм или ступеньки). Если явно не задана, то osmpie 
пытается автоматически определить, исходя из угла пересечения way в этой точке, если их 2 или 4. Случаи для более 5 way
надо тегировать явно и вручную.
2. `junction:radius` - радиус окружности, соотносящийся с зоной конфликта, в котором участвуют 
транспортные средства.
3. `junction:radius:lanes` - переопределение зоны конфликта, заданной в точке, для выбранного объекта типа way. 
Например, смещения стоп-линии для каждой полосы объекта типа way. 
4. `junction:cluster:radius` - радиус окружности, который нужен для объединения точек пересечений между собой 
в один "настоящий" в обычном понимании перекрёсток или в нашей терминологии — кластер пересечений. 
5. `crossing:corner = yes|no` - Тег для точек пешеходных переходов, подобно тегу `crossing:island`
[см. crossing:island](https://wiki.openstreetmap.org/wiki/Key:crossing:island), который 
указывает на наличие островка безопасности. Этот тег отмечает факт, что пешеходный переход находится 
очень близко к проезжей части справа или слева. То есть фактически проведён от одного угла тротуара 
к другому углу. Учёт этого случая позволяет строить более правильные формы пересечения.
6. `connect:lanes` - более удобный способ адресации к полосам для точного указания связности в ноде, 
как альтернатива отношений. [relation[type=connectivity]](https://wiki.openstreetmap.org/wiki/Relation:connectivity)

Познакомьтесь со статьями, которые более подробно описывают эти ключи и их применение:
- [junction:shape](./node.tags.junction:shape.md)
- [junction:radius](./node.tags.junction:radius.md)
- [junction:cluster:radius](./node.tags.junction:cluster:radius.md)
- [connect:lanes](./way.tags.connect:lanes.md)

---

## 5. Парковки, остановки, велодорожки и трамваи
В первой версии osmpie была добавлена частичная поддержка тегов парковки и велодорожек.
Ровно в той мере, в какой они влияют на ширину проезжей части и полигоны дороги.
Учитывается расположение и ширина, для парковок ещё ориентация, которая определяет 
ширину парковочной полосы.

**Парковки и велодорожки:**  
```osm
way
    parking:{side} = lane|street_side
    parking:{side}:orientation = number
    parking:{side}:width = number
    
way   
    cycleway:{side} = lane
    cycleway:{side}:width = number    
```
[Ссылка на статьи примеры на эту тему](./examples/parking.md)

**Остановки:**
Отдельное внимание уделено автобусным остановкам. Предложено использовать ключ `bus_bay` не только для
way, но и для node остановки `highway = bus_stop`, который позволит указать, что остановка находится 
в кармане, и правильно отрисовать этот карман и разметку в нём. 
Для остановок, в которых указан тег `tram=yes`, применяется другой вид разметки — перпендикулярный полосам движения.
  
```osm
node
   highway = bus_stop + bus_bay = yes
   highway = bus_stop + tram = yes 
```

[Примеры использования bus_bay=yes в OSMPIE](./examples/bus_bay.md)

**Особенности:**  
- Отдельно стоит упомянуть, что пересечения автомобильных путей с трамвайными путями и велодорожками игнорируются, если не помечены какими-либо тегами,
например `highway = traffic_signals`, потому что не требуют решения связности этих пересечений. Учёт этих пересечений порождает много мелких рёбер и 
искажает геометрическую картину полос на автомобильной дороге.  

---

## 6. Вспомогательные теги для управления рендером

В osmpie существует набор дополнительных тегов, которыми можно управлять рендером. 
Большинство из них применяются крайне редко, в особо исключительных случаях:

```osm
    osmpie:{key} = any
    osmpie:sparse = yes|no|number
    osmpie:fill = yes|no|number
    osmpie:usefull = yes|no
```

* `osmpie:{key} = any` - переопределяет значения любого тега, если он есть. Например, [перекрёсток на мосту или мост внутри перекрёстка](https://www.openstreetmap.org/way/243947044#map=19/59.935411/30.326399). 
osmpie разделяет рендер полигонов дороги для разных уровней для тоннелей, развязок и перекрёстков под/над ними. Редко-редко, но перекрёсток может быть частью моста
 или мост внутри перекрёстка, и тогда невозможно построить полигон перекрёстка. И при этом изменить тег level для моста противоречит правилам OSM.
Тогда можно переопределить `osmpie:level = 0 + level = 2`. 

* `osmpie:sparse = yes|no|number` - В osmpie работает процедура удаления лишних точек на way, которые находятся близко друг к другу и не имеют тегов.
Этот тег явным образом указывает, надо ли это делать для конкретного вэй и с какими ограничениями.

* `osmpie:fill = yes|no|number` - В osmpie работает процедура наполнения way точками, если есть длинные участки без точек. 
Этот тег явным образом указывает, надо ли это делать для конкретного вэй и с какими ограничениями.

* `osmpie:usefull = yes|no` - Вэи типа `way[highway = service]` не используются для конечного рендера и фильтруются. Но иногда некоторые вэи полезны, 
этот тег обозначает, что его не надо удалять.

[Более подробные примеры на эту тему](./examples/fill.sparse.md)

---

## 7. Разметка (скоро)

В первой публичной версии osmpie разметка не управляема и генерируется по максимуму и может не отражать некоторых местных особенностей нанесения.
Например, парковочных мест или пешеходных переходов. И её рендер осуществляется, чтобы дать понять о существовании 
того или иного объекта, полосы и её размерах. Однако мы надеемся это быстро исправить в первую очередь.

Типичными тегами, указывающими на дорожную разметку, являются, например, `divider`, `turn:lanes=*`, `overtaking=*`, `change=*` или `crossing:markings=*.` 
Наличие разметки на дороге можно указать с помощью `lane_markings=*`. 
Использование вышеупомянутых тегов в сочетании 
с дополнительной информацией, такой как `placement=*` или `width:lanes=*`,
достаточно для управления рендером дорожной разметки.

- [Key:divider](https://wiki.openstreetmap.org/wiki/Key:divider)
- [Key:change](https://wiki.openstreetmap.org/wiki/Key:change)
- [Key:overtaking](https://wiki.openstreetmap.org/wiki/Key:overtaking)
- [Key:crossing:markings](https://wiki.openstreetmap.org/wiki/Key:crossing:markings)
- [Key:lane_markings](https://wiki.openstreetmap.org/wiki/Key:lane_markings)
- [Tag:road_marking=solid_stop_line](https://wiki.openstreetmap.org/wiki/Tag:road_marking=solid_stop_line)

Отдельно стоит присмотреться к предложению [Proposal:Road_marking_revision](https://wiki.openstreetmap.org/wiki/Proposal:Road_marking_revision)
, которое мы поддерживаем на 99%, за исключением того, что знаки поворотов и текстов на полосе должны быть обозначены как way-объекты.
Возможно, разрешить применять и к точечным объектам, а угол задавать в атрибутах или вычислять из
угла way, которому принадлежит нода, с добавлением `direction = {forward|backward}`, как это применяется сейчас для [светофоров](https://wiki.openstreetmap.org/wiki/Key:traffic_signals:direction).