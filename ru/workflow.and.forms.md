# 1. Порядок работы и формы ввода

Общий порядок работы с OSMPIE.

1. Загруженные из OSM данные отражаются в левой (редактор) и правой (рендер) частях экрана.
2. Редактируйте объекты в левой части экрана с помощью мыши: выделяйте, добавляйте, удаляйте и изменяйте объекты. Доступные функции представлены в меню, расположенном вдоль правой стороны левого экрана. В правом экране отображается внешний вид отредактированного перекрёстка.
3. Окно просмотра **Changeset viewer** позволяет посмотреть, какие изменения были сделаны и что будет отправлено на сервер OSM. Здесь можно скачать файл **OSMcs**. Кнопки рядом с кнопкой 'Changeset viewer' отменяют последние шаги (Undo) и возвращают отменённые (Repeat).
4. Если в процессе редактирования вы удалили ключевой объект перекрёстка (node или way) или разделили (split) way, то перед отправкой изменений на сервер OSM вам будет предложено исправить все **relations**, связанные с удалёнными объектами. Если система не выявила конфликтов, переходим к шагу отправки.
5. В случае автоматического исправления relations дальнейшее редактирование будет запрещено, а ваша модель переведена в режим "только чтение". При наличии достаточных навыков вы можете вручную исправить relations. Либо необходимо отменить этот шаг и вернуться к редактированию.
6. В любой момент времени вы можете поделиться ссылкой с другим участником для обсуждения вашей модели. Изменения в проект может вносить только автор, остальным участникам доступен только просмотр.
7. После отправки в OSM ваша работа переходит в режим "только чтение" для автора тоже.

---

## 2. Окно редактирования свойств объекта

Для редактирования свойств объекта его нужно выделить мышкой и нажать кнопку **View/Change Object's** в левом нижнем углу экрана. Она активирует режим просмотра/редактирования свойств.

![image info](./img/screen4.png)

Данные представлены в формате **YAML!** со всеми вытекающими из этого [плюсами и минусами](https://ru.wikipedia.org/wiki/YAML).

В форме работает автозаполнение для ускорения рутинной работы по исправлению свойств. Имейте в виду, что представленные схемы тегов не полные.

Чтобы деактивировать режим просмотра/редактирования свойств, необходимо ещё раз нажать на ту же кнопку.

---

## 3. Окно опций рендера OSMPIE (Options and Defaults)

Данное окно вызывается нажатием на кнопку с тремя вертикальными точками, находящуюся в верхнем левом углу правого экрана (рендер). В этом окне необходимо отредактировать параметры выбранного объекта с целью максимально точно воспроизвести его топологические особенности.

![image info](./img/screen5.png)

| Опция | Назначение/описание |
| :------- | :------ |
| `Lane's width ([p,s,t] + width:lanes) (m)` | Базовая ширина полосы в метрах для основных дорог (primary, secondary, tertiary). Остальные значения получаются умножением этого значения на соответствующие коэффициенты. Значения можно переопределить тегом `width:lanes: *` |
| `Remove edges less than ... (m)` | Удаляет рёбра результирующего графа длиной менее Х метров (иногда при отладке полезно установить 0) |
| `Default way's osmpie:fill value (veh,bus,psv) (m)` | Устанавливает новую точку каждые Х метров для дорог |
| `Default way's osmpie:fill value (tram,cycle) (m)` | Устанавливает новую точку каждые Х метров для трамваев и велосипедов |
| `Default node's junction:cluster:radius value (m)` | Базовое значение junction:cluster:radius для всех точек, если иное не переопределено в свойствах node |
| `Max route radius (m)` | Расстояние от центра перекрёстка до начала и конца микро-маршрутов |
| `Max area of polygon's hole filling (sq. m)` | Предельная площадь "дырок" полигона, которые нужно заливать цветом асфальта|
| `Ignore restriction relations` | Позволяет игнорировать все relation типа restriction. Иногда это удобно |
| `Filter way[highway=service]` | Если установить эту опцию, то way[service] будут попадать в рендер. Иногда это позволяет получить идеальный результат |
| `1. Step connect points` | Шаги с 1 по 4 отладочные, рекомендуется оставить их включёнными |
| `2. Step connect rest veh` | ... |
| `3. Step connect extra (tram,cycle,ped)` | ... |
| `4. Step guess stoplines` | ... |
| `5. Step build routes` | Определяем, необходимо ли строить микро-маршруты (micro-routes) через перекрёстки |
| `6. Step build road MultiPolygon` | Строим полигоны дороги |
| `7. Step build conflict points` | Поиск конфликтных точек на пересечении |
| `8. Step build road markings` | Рисуем линейную разметку на дорогах |
| `8.1 Step build intersection markings` | Рисуем разметку на перекрёстке |

---

## 4. Changeset viewer – просмотр изменений

В данном окне представлен полный пошаговый список внесённых вами правок. 
Окно вызывается нажатием на кнопку с цифрами в кружочках, расположенную в верхнем меню левой части экрана. 

![image info](./img/screen6.png)

В списке представлены элементы, которые были удалены, добавлены или изменены.
Список упорядочен по времени изменения (новые сверху). Можно отфильтровать нужные элементы по операции, объекту или идентификатору.
Выбрав определённый объект в нижней части окна, мы видим подсвеченными изменения, произведённые с этим объектом относительно его начального состояния, которое было загружено в последний раз из OSM.
Работа с различиями организована по подобию с [Git](https://git-scm.com).

---

## 5. Changeset viewer – целостность ссылок, исправление relations

Если вы удаляли объекты way или node либо применяли операцию split к объекту way, то редактор предложит вам автоматически исправить ссылки на удалённые объекты. Нажмите кнопку **Check & fix relation**, чтобы программа обратилась к **overpass API** и выбрала все relations, которые имеют отношение к удалённым объектам.

1. Для разделённых (splitted) way старые ссылки в member будут заменены на ссылки новых way (с учётом порядка для route).
2. Для удалённых объектов система просто удалит ссылки.
3. В случае если вы удалили way и вместо него создали новый way, то необходимо будет исправить relations вручную.
4. После фикса relations редактирование будет запрещено, редактор перейдёт в режим "только чтение".
5. Вернуться к редактированию можно, нажав кнопку отмены **Cancel relation fix**

![image info](./img/screen7.png)

---

## 6. Changeset viewer – отправка изменений в OSM

Когда внесены все необходимые изменения и отредактированы все ссылки, вы можете отправить свой перекрёсток в OSM. Нажимайте кнопку **Apply to OSM**, чтобы перейти к финальному шагу.
Останется только ввести комментарий к вашему changeset и выбрать или дописать свои теги источников. 
Поздравляем вас с новым совершенным перекрёстком в OSM!

![image info](./img/screen8.png)

---

## 7. Просмотр микро-маршрутов для валидации перекрёстка

Свойства объектов, воспроизведённых рендером на правом экране, можно просмотреть, выбрав объект мышкой. При выборе объектов типа кластер (облако гексагонов) появляется дополнительное окно, позволяющее выбрать и отобразить микро-маршруты (micro-routes), которые были построены OSMPIE для этого перекрёстка.

Данная визуализация позволяет быстро оценивать правильность структуры полос и связность по каждому подходу.

![image info](./img/screen11.png)

---

## 8. Редактор в режиме "только чтение"

Режим "только чтение" исключает возможность внесения изменений. Он активируется после того, как были исправлены relations или changeset отправлен в OSM. Также ваша работа представляется в таком виде пользователю, которому вы отправили ссылку на созданные вами изменения.

Вы можете использовать этот режим не только для того, чтобы обсуждать детали своей работы с другими участниками, но и для того, чтобы сравнить несколько вариантов одного 
перекрёстка в разных вкладках. 

В окне редактора (левый экран) можно включить режим отображения "было/стало".
В окне рендера (правый экран) можно использовать переключатель **use changes** для этих же целей.

![image info](./img/screen9.png)

---

## Рекомендуемые статьи

[Как приготовить идеальный перекрёсток](./perfect.junction.md)